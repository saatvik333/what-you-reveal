/**
 * Report Generation Module
 * Generates and downloads a text-based system report.
 */

export function downloadReport() {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = `system_analysis_${timestamp}.txt`;
    
    let report = `
=============================================================
      WHAT YOU REVEAL - SYSTEM ANALYSIS REPORT
=============================================================
Date: ${new Date().toLocaleString()}
User Agent: ${navigator.userAgent}
=============================================================

`;

    // Gather all info blocks from the DOM
    const blocks = document.querySelectorAll('.card');
    
    blocks.forEach(card => {
        const title = card.querySelector('h2').textContent;
        report += `
[ ${title} ]
`;
        report += '-'.repeat(title.length + 4) + '\n';
        
        const content = card.querySelector('.info-block');
        if (content) {
            // Extract text from the "terminal-table" structure
            // Or fallback to innerText if simple pre
            if (content.querySelector('.terminal-table')) {
                const rows = content.querySelectorAll('.terminal-row');
                rows.forEach(row => {
                    const key = row.querySelector('.key').textContent;
                    const val = row.querySelector('.value').textContent;
                    report += `${key.padEnd(30)}: ${val}\n`;
                });
            } else {
                // Raw text (like headers)
                report += content.innerText + '\n';
            }
        }
        report += '\n';
    });

    report += `
=============================================================
END OF REPORT
Generated by What You Reveal
=============================================================
`;

    // Create Blob and trigger download
    const blob = new Blob([report], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    
    // Cleanup
    setTimeout(() => {
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }, 100);
}
